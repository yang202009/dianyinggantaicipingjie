<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå½±æ„Ÿå­—å¹•æ‹¼æ¥å·¥å…·</title>
    <style>
        :root {
            --primary-color: #00f0ff;
            --primary-hover: #00d4ff;
            --secondary-color: #a855f7;
            --accent-color: #ec4899;
            --bg-color: #0a0a0f;
            --bg-gradient-start: #1a0b2e;
            --bg-gradient-end: #0f0520;
            --panel-bg: rgba(20, 20, 35, 0.7);
            --border-color: rgba(0, 240, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --shadow-sm: 0 4px 16px rgba(0, 240, 255, 0.1);
            --shadow-md: 0 8px 32px rgba(0, 240, 255, 0.15);
            --shadow-glow: 0 0 20px rgba(0, 240, 255, 0.3);
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 40px 20px;
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(0, 240, 255, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            animation: gradientShift 20s ease infinite;
            z-index: 0;
            pointer-events: none;
        }

        @keyframes gradientShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(5%, 5%) rotate(120deg); }
            66% { transform: translate(-5%, 5%) rotate(240deg); }
        }

        h1 {
            margin-bottom: 50px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            font-size: 48px;
            letter-spacing: -1.5px;
            text-align: center;
            position: relative;
            z-index: 1;
            text-shadow: 0 0 40px rgba(0, 240, 255, 0.3);
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .container {
            display: flex;
            gap: 40px;
            width: 100%;
            max-width: 1200px;
            background: var(--panel-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            padding: 50px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            opacity: 0.5;
        }

        .controls {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .preview-area {
            flex: 1.5;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: rgba(10, 10, 20, 0.5);
            padding: 30px;
            border-radius: var(--radius-lg);
            overflow: auto;
            border: 1px solid var(--border-color);
            min-height: 500px;
            position: relative;
        }

        .preview-area::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--radius-lg);
            padding: 1px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.3;
        }

        .control-group {
            background: rgba(30, 30, 50, 0.6);
            border-radius: var(--radius-md);
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .control-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .control-group:hover {
            box-shadow: var(--shadow-glow);
            transform: translateY(-4px);
            border-color: var(--primary-color);
        }

        .control-group:hover::before {
            left: 100%;
        }

        .control-group h3 {
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--primary-color);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            padding-bottom: 12px;
        }

        .control-group h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
        }

        /* Select & Inputs for Export */
        select, .custom-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(10, 10, 20, 0.6);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            color: var(--text-primary);
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300f0ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 12px;
            transition: all 0.3s ease;
        }

        select:hover, .custom-input:hover {
            border-color: var(--primary-color);
            background: rgba(10, 10, 20, 0.8);
        }

        select:focus, .custom-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.2);
        }

        .custom-inputs-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }

        .custom-input-group {
            flex: 1;
        }

        .custom-input {
            background-image: none; /* No arrow for text inputs */
        }

        /* Custom File Upload Styling */
        .file-upload-wrapper {
            position: relative;
            width: 100%;
            height: 160px;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: rgba(10, 10, 20, 0.4);
            cursor: pointer;
            overflow: hidden;
            text-align: center;
        }

        .file-upload-wrapper:hover {
            border-color: var(--primary-color);
            background: rgba(0, 240, 255, 0.05);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
        }

        .file-upload-wrapper.has-file {
            border-style: solid;
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-glow);
        }

        .file-upload-wrapper input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 16px;
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 10px rgba(0, 240, 255, 0.5));
        }

        .file-upload-wrapper:hover .upload-icon {
            transform: scale(1.15) translateY(-5px);
            filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.8));
        }

        .upload-text {
            font-size: 15px;
            color: var(--text-primary);
            font-weight: 600;
            padding: 0 20px;
        }

        .upload-subtext {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Modern Neon Slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(0, 240, 255, 0.1);
            border-radius: 3px;
            outline: none;
            margin: 12px 0 28px 0;
            display: block;
            position: relative;
            border: 1px solid var(--border-color);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.6), 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.9), 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(0, 240, 255, 1), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .range-value {
            font-size: 14px;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        textarea {
            width: 100%;
            height: 180px;
            padding: 18px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            resize: vertical;
            font-family: 'JetBrains Mono', 'Fira Code', monospace, inherit;
            font-size: 15px;
            line-height: 1.8;
            box-sizing: border-box;
            background: rgba(10, 10, 20, 0.6);
            color: var(--text-primary);
            transition: all 0.3s ease;
            outline: none;
        }

        textarea:hover {
            border-color: var(--primary-color);
            background: rgba(10, 10, 20, 0.8);
        }

        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.2), inset 0 0 20px rgba(0, 240, 255, 0.05);
            background: rgba(10, 10, 20, 0.9);
        }

        .helper-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        button.download-btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 18px 32px;
            border-radius: var(--radius-md);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 8px 24px rgba(0, 240, 255, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
        }

        button.download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        button.download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 240, 255, 0.5), 0 0 40px rgba(168, 85, 247, 0.3);
        }

        button.download-btn:hover::before {
            left: 100%;
        }

        button.download-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(0, 240, 255, 0.4);
        }

        canvas {
            max-width: 100%;
            border-radius: var(--radius-sm);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px var(--border-color);
            border: 2px solid var(--border-color);
            position: relative;
            z-index: 1;
        }

        /* éšè—åŸå§‹å›¾ç‰‡ï¼Œåªç”¨äºè¯»å– */
        #sourceImage {
            display: none;
        }

        #placeholderText {
            color: var(--text-secondary);
            margin-top: 100px;
            font-size: 16px;
            opacity: 0.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            h1 {
                font-size: 36px;
            }

            .container {
                padding: 30px 20px;
            }

            .controls, .preview-area {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>

    <h1>ğŸ¬ ç”µå½±å­—å¹•æ‹¼æ¥ç”Ÿæˆå™¨</h1>

    <div class="container">
        <!-- å·¦ä¾§æ§åˆ¶åŒº -->
        <div class="controls">
            
            <!-- 1. å›¾ç‰‡ä¸Šä¼  -->
            <div class="control-group">
                <h3>ğŸ–¼ï¸ ä¸Šä¼ åº•å›¾</h3>
                <div class="file-upload-wrapper" id="uploadWrapper">
                    <input type="file" id="imageInput" accept="image/*">
                    <div class="upload-icon">â˜ï¸</div>
                    <div class="upload-text" id="uploadText">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œ</div>
                    <div class="upload-subtext">æ”¯æŒ JPG, PNG</div>
                </div>
                <img id="sourceImage" alt="Source">
            </div>

            <!-- 2. æ–‡æœ¬ç¼–è¾‘ -->
            <div class="control-group">
                <h3>âœï¸ ç¼–è¾‘å°è¯</h3>
                <textarea id="subtitleInput" placeholder="è¯·è¾“å…¥å­—å¹•...
ç¬¬ä¸€è¡Œå­—å¹•å‡ºç°åœ¨å®Œæ•´å›¾ç‰‡ä¸Š
ç¬¬äºŒè¡Œå­—å¹•å‡ºç°åœ¨æ‹¼æ¥åˆ‡ç‰‡ä¸Š
ç¬¬ä¸‰è¡Œå­—å¹•å‡ºç°åœ¨æ‹¼æ¥åˆ‡ç‰‡ä¸Š...">
å˜¿ï¼Œæˆ‘æ˜¯ç¤¾ä¼šå–µå“¥
äººç±»ï¼Œç­‰ç€å§
èµ›åšä¸–ç•Œï¼Œä¹Ÿæœ‰æˆ‘çš„ä¸€å¸­ä¹‹åœ°</textarea>
                <div class="helper-text">æç¤ºï¼šæ¯ä¸€è¡Œæ–‡å­—éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ‹¼æ¥å±‚ï¼ˆç¬¬ä¸€è¡Œé™¤å¤–ï¼‰ã€‚</div>
            </div>

            <!-- 3. å‚æ•°è°ƒèŠ‚ -->
            <div class="control-group">
                <h3>ğŸ¨ è§†è§‰è°ƒæ•´</h3>
                
                <label>
                    åˆ‡ç‰‡é«˜åº¦ (å‘ˆç°åˆ‡å‰²æ„Ÿçš„å…³é”®)
                    <span id="sliceHeightVal" class="range-value">20%</span>
                </label>
                <input type="range" id="sliceHeight" min="5" max="50" value="20">
                
                <label>
                    æ–‡å­—å¤§å°
                    <span id="fontSizeVal" class="range-value">32px</span>
                </label>
                <input type="range" id="fontSize" min="12" max="100" value="32">

                <label>
                    æ–‡å­—å‚ç›´åç§»
                    <span id="textOffsetVal" class="range-value">10px</span>
                </label>
                <input type="range" id="textOffset" min="-50" max="50" value="10">

                <label>
                    è¡Œé—´è· (å¾®è°ƒ)
                    <span id="lineSpacingVal" class="range-value">0</span>
                </label>
                <input type="range" id="lineSpacing" min="0" max="50" value="0">
            </div>

            <!-- 4. å¯¼å‡ºè®¾ç½® -->
            <div class="control-group">
                <h3>ğŸ“¤ å¯¼å‡ºè®¾ç½®</h3>
                <label>é€‰æ‹©ç›®æ ‡å¹³å°</label>
                <select id="exportPlatform">
                    <option value="original">åŸå§‹å°ºå¯¸ (é»˜è®¤)</option>
                    <option value="wechat">å¾®ä¿¡å…¬ä¼—å· (å®½ 1080px)</option>
                    <option value="xhs">å°çº¢ä¹¦ (3:4 å°é¢)</option>
                    <option value="twitter">X / Twitter (16:9 å°é¢)</option>
                    <option value="custom">è‡ªå®šä¹‰å°ºå¯¸...</option>
                </select>

                <div class="custom-inputs-row" id="customInputs">
                    <div class="custom-input-group">
                        <label style="font-size: 12px; margin-bottom: 4px;">å®½åº¦ (px)</label>
                        <input type="number" id="customWidth" class="custom-input" placeholder="å®½åº¦">
                    </div>
                    <div class="custom-input-group">
                        <label style="font-size: 12px; margin-bottom: 4px;">é«˜åº¦ (px, å¯é€‰)</label>
                        <input type="number" id="customHeight" class="custom-input" placeholder="é«˜åº¦ (ç•™ç©ºåˆ™è‡ªé€‚åº”)">
                    </div>
                </div>
            </div>

            <button class="download-btn" id="downloadBtn">ğŸ“¥ ä¸‹è½½ç”Ÿæˆçš„å›¾ç‰‡</button>
        </div>

        <!-- å³ä¾§é¢„è§ˆåŒº -->
        <div class="preview-area">
            <canvas id="resultCanvas"></canvas>
            <p id="placeholderText">è¯·ä¸Šä¼ å›¾ç‰‡ä»¥å¼€å§‹...</p>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const sourceImage = document.getElementById('sourceImage');
        const subtitleInput = document.getElementById('subtitleInput');
        const sliceHeightInput = document.getElementById('sliceHeight');
        const fontSizeInput = document.getElementById('fontSize');
        const textOffsetInput = document.getElementById('textOffset');
        const lineSpacingInput = document.getElementById('lineSpacing');
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const downloadBtn = document.getElementById('downloadBtn');
        const placeholderText = document.getElementById('placeholderText');

        const uploadWrapper = document.getElementById('uploadWrapper');
        const uploadText = document.getElementById('uploadText');

        const exportPlatform = document.getElementById('exportPlatform');
        const customInputs = document.getElementById('customInputs');
        const customWidthInput = document.getElementById('customWidth');
        const customHeightInput = document.getElementById('customHeight');

        // å¯¼å‡ºè®¾ç½®å˜åŒ–ç›‘å¬
        exportPlatform.addEventListener('change', () => {
            if (exportPlatform.value === 'custom') {
                customInputs.style.display = 'flex';
            } else {
                customInputs.style.display = 'none';
            }
        });

        // æ˜¾ç¤ºæ•°å€¼
        function updateLabels() {
            document.getElementById('sliceHeightVal').textContent = sliceHeightInput.value + '%';
            document.getElementById('fontSizeVal').textContent = fontSizeInput.value + 'px';
            document.getElementById('textOffsetVal').textContent = textOffsetInput.value + 'px';
            document.getElementById('lineSpacingVal').textContent = lineSpacingInput.value + 'px';
        }

        // æ ¸å¿ƒç”Ÿæˆé€»è¾‘
        function generateImage() {
            if (!sourceImage.src || sourceImage.src === window.location.href) return;

            placeholderText.style.display = 'none';
            canvas.style.display = 'block';

            // æ›´æ–°ä¸Šä¼ æ¡†çŠ¶æ€
            uploadWrapper.classList.add('has-file');
            uploadWrapper.querySelector('.upload-icon').textContent = 'âœ…';
            
            const lines = subtitleInput.value.split('\n'); 
            // å¦‚æœæ²¡æœ‰æ–‡å­—ï¼Œè‡³å°‘æ˜¾ç¤ºä¸€å¼ åŸå›¾
            // ç©ºè¡Œä¹Ÿä¿ç•™ï¼Œä½œä¸ºä¸å¸¦æ–‡å­—çš„åˆ‡ç‰‡
            const textLines = lines.length > 0 ? lines : [];

            const imgWidth = sourceImage.naturalWidth;
            const imgHeight = sourceImage.naturalHeight;

            // è·å–å‚æ•°
            const slicePercent = parseInt(sliceHeightInput.value) / 100;
            const sliceH = Math.floor(imgHeight * slicePercent); // åˆ‡ç‰‡çš„é«˜åº¦ï¼ˆåƒç´ ï¼‰
            const fontSize = parseInt(fontSizeInput.value);
            const textOffset = parseInt(textOffsetInput.value);
            const lineSpacing = parseInt(lineSpacingInput.value);

            // è®¡ç®—æœ€ç»ˆç”»å¸ƒé«˜åº¦
            // é€»è¾‘ï¼š
            // 1. ç¬¬ä¸€è¡Œæ–‡å­—ï¼šå ç”¨å®Œæ•´çš„å›¾ç‰‡é«˜åº¦
            // 2. åç»­æ¯è¡Œæ–‡å­—ï¼šå ç”¨ä¸€ä¸ª sliceH çš„é«˜åº¦
            // å¦‚æœæ²¡æœ‰æ–‡å­—ï¼Œå°±åªæ˜¾ç¤ºåŸå›¾
            let totalHeight = imgHeight;
            if (textLines.length > 1) {
                totalHeight += (textLines.length - 1) * (sliceH + lineSpacing);
            }

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            canvas.width = imgWidth;
            canvas.height = totalHeight;

            // 1. ç»˜åˆ¶ç¬¬ä¸€éƒ¨åˆ†ï¼ˆå®Œæ•´åº•å›¾ï¼‰
            ctx.drawImage(sourceImage, 0, 0);

            // ç»˜åˆ¶ç¬¬ä¸€è¡Œæ–‡å­—
            if (textLines.length > 0 && textLines[0].trim() !== '') {
                drawText(textLines[0], imgWidth / 2, imgHeight - (sliceH / 2) + textOffset, fontSize);
            }

            // 2. ç»˜åˆ¶åç»­åˆ‡ç‰‡
            for (let i = 1; i < textLines.length; i++) {
                // è®¡ç®—å½“å‰åˆ‡ç‰‡çš„ç»˜åˆ¶ä½ç½® (y)
                // ç¬¬ä¸€å¼ å›¾å ç”¨äº† imgHeight
                // ä¹‹å‰çš„åˆ‡ç‰‡å ç”¨äº† (i-1) * (sliceH + lineSpacing)
                // åŠ ä¸Šé—´è· (è™½ç„¶é€šå¸¸æ˜¯0)
                const dy = imgHeight + (i - 1) * (sliceH + lineSpacing) + lineSpacing;

                // æºå›¾åƒæˆªå–ä½ç½®ï¼šä»åº•éƒ¨å¾€ä¸Šæ•° sliceH çš„é«˜åº¦
                // sx, sy, sw, sh -> dx, dy, dw, dh
                const sy = imgHeight - sliceH;
                
                // ç»˜åˆ¶åˆ‡ç‰‡èƒŒæ™¯
                ctx.drawImage(sourceImage, 
                    0, sy, imgWidth, sliceH, // source
                    0, dy, imgWidth, sliceH  // destination
                );

                // ç»˜åˆ¶æ–‡å­—
                // æ–‡å­—ä½ç½®åœ¨å½“å‰åˆ‡ç‰‡çš„ä¸­é—´
                if (textLines[i].trim() !== '') {
                     drawText(textLines[i], imgWidth / 2, dy + (sliceH / 2) + textOffset, fontSize);
                }
            }
        }

        // ç»˜åˆ¶æ–‡å­—çš„è¾…åŠ©å‡½æ•°
        function drawText(text, x, y, size) {
            ctx.font = `bold ${size}px sans-serif`;
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // æè¾¹æ•ˆæœï¼Œå¢å¼ºå¯¹æ¯”åº¦
            ctx.lineWidth = size / 8;
            ctx.strokeStyle = 'black';
            ctx.strokeText(text, x, y);
            
            ctx.fillText(text, x, y);
        }

        // äº‹ä»¶ç›‘å¬
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                uploadText.textContent = file.name; // æ˜¾ç¤ºæ–‡ä»¶å
                const reader = new FileReader();
                reader.onload = (event) => {
                    sourceImage.src = event.target.result;
                    sourceImage.onload = generateImage;
                };
                reader.readAsDataURL(file);
            }
        });

        [subtitleInput, sliceHeightInput, fontSizeInput, textOffsetInput, lineSpacingInput].forEach(input => {
            input.addEventListener('input', () => {
                updateLabels();
                generateImage();
            });
        });

        // ä¸‹è½½åŠŸèƒ½
        downloadBtn.addEventListener('click', () => {
            if (canvas.width === 0) return;

            // åˆ›å»ºä¸€ä¸ªæ–°çš„ Canvas ç”¨äºæœ€ç»ˆå¯¼å‡ºå¤„ç†
            const exportCanvas = document.createElement('canvas');
            const eCtx = exportCanvas.getContext('2d');
            const platform = exportPlatform.value;

            // åŸå§‹æ‹¼æ¥å›¾å°ºå¯¸
            const srcWidth = canvas.width;
            const srcHeight = canvas.height;

            let targetWidth = srcWidth;
            let targetHeight = srcHeight;
            let forceRatio = null; // null, '3:4', '16:9', etc.

            // 1. ç¡®å®šç›®æ ‡å°ºå¯¸é€»è¾‘
            if (platform === 'wechat') {
                targetWidth = 1080;
                targetHeight = (srcHeight / srcWidth) * targetWidth; // ä¿æŒæ¯”ä¾‹ç¼©æ”¾
            } else if (platform === 'xhs') {
                targetWidth = 1242;
                // å°çº¢ä¹¦ 3:4 æ¯”ä¾‹
                forceRatio = 3 / 4; 
                // å¦‚æœåŸå§‹å›¾éå¸¸é•¿ï¼ˆè¶…è¿‡ 3:4ï¼‰ï¼Œåˆ™ä¿æŒé•¿å›¾æ¨¡å¼ï¼Œä»…è°ƒæ•´å®½åº¦ï¼ˆå°çº¢ä¹¦æ”¯æŒé•¿å›¾ï¼‰
                // è¿™é‡Œæˆ‘ä»¬åšä¸ªåˆ¤æ–­ï¼šå¦‚æœæ¯” 3:4 æ›´é•¿ï¼Œå°±åªå®šå®½ï¼›å¦‚æœæ¯” 3:4 çŸ­ï¼Œå°±è¡¥èƒŒæ™¯
                if (srcHeight / srcWidth > forceRatio) {
                    targetHeight = (srcHeight / srcWidth) * targetWidth;
                    forceRatio = null; // å–æ¶ˆå¼ºåˆ¶æ¯”ä¾‹ï¼Œå˜ä¸ºæ™®é€šé•¿å›¾
                } else {
                    targetHeight = targetWidth / forceRatio;
                }
            } else if (platform === 'twitter') {
                targetWidth = 1200;
                forceRatio = 16 / 9;
                // æ¨ç‰¹é€šå¸¸æ˜¯æ¨ªå±é¢„è§ˆï¼Œä½†ä¹Ÿæ”¯æŒç«–å±ã€‚å¦‚æœæ˜¯åšâ€œå°é¢â€ï¼Œæˆ‘ä»¬å¼ºåˆ¶ 16:9
                targetHeight = targetWidth / forceRatio;
            } else if (platform === 'custom') {
                const w = parseInt(customWidthInput.value);
                const h = parseInt(customHeightInput.value);
                if (w > 0) targetWidth = w;
                if (h > 0) {
                    targetHeight = h;
                    forceRatio = 'custom'; // æ ‡è®°ä¸ºå¼ºåˆ¶å°ºå¯¸
                } else {
                    targetHeight = (srcHeight / srcWidth) * targetWidth;
                }
            }

            // è®¾ç½®å¯¼å‡ºç”»å¸ƒå°ºå¯¸
            exportCanvas.width = targetWidth;
            exportCanvas.height = targetHeight;

            // 2. ç»˜åˆ¶é€»è¾‘
            // å¡«å……èƒŒæ™¯è‰² (é¿å…é€æ˜)
            eCtx.fillStyle = '#000000'; 
            eCtx.fillRect(0, 0, targetWidth, targetHeight);

            if (forceRatio) {
                // éœ€è¦â€œåŒ…å«â€ (Contain) æ¨¡å¼ + èƒŒæ™¯æ¨¡ç³Š
                
                // A. ç»˜åˆ¶æ¨¡ç³ŠèƒŒæ™¯
                // ç®€å•æ¨¡æ‹Ÿï¼šæ‹‰ä¼¸åŸå›¾å¡«æ»¡ + æ¨¡ç³Šæ»¤é•œ
                eCtx.save();
                eCtx.filter = 'blur(20px) brightness(0.6)';
                // ä¸ºäº†å¡«æ»¡ï¼Œéœ€è¦ cover æ¨¡å¼è®¡ç®—
                const scaleBg = Math.max(targetWidth / srcWidth, targetHeight / srcHeight);
                const bgW = srcWidth * scaleBg;
                const bgH = srcHeight * scaleBg;
                eCtx.drawImage(canvas, (targetWidth - bgW) / 2, (targetHeight - bgH) / 2, bgW, bgH);
                eCtx.restore();

                // B. ç»˜åˆ¶ä¸»ä½“ (Contain)
                const scaleFg = Math.min(targetWidth / srcWidth, targetHeight / srcHeight);
                const fgW = srcWidth * scaleFg;
                const fgH = srcHeight * scaleFg;
                
                // å¢åŠ é˜´å½±è®©ä¸»ä½“çªèµ·
                eCtx.shadowColor = "rgba(0, 0, 0, 0.5)";
                eCtx.shadowBlur = 20;
                eCtx.shadowOffsetY = 10;
                
                eCtx.drawImage(canvas, (targetWidth - fgW) / 2, (targetHeight - fgH) / 2, fgW, fgH);

            } else {
                // æ™®é€šç¼©æ”¾æ¨¡å¼ (Stretch/Fit Width)
                eCtx.drawImage(canvas, 0, 0, targetWidth, targetHeight);
            }

            const link = document.createElement('a');
            link.download = `subtitle-${platform}-${Date.now()}.png`;
            link.href = exportCanvas.toDataURL('image/png');
            link.click();
        });

        // åˆå§‹åŒ–
        updateLabels();

        // åŠ è½½é»˜è®¤å›¾ç‰‡ç”¨äºæ¼”ç¤ºï¼ˆå¯é€‰ï¼Œè¿™é‡Œç”¨ä¸€ä¸ªç°è‰²å ä½æˆ–ä¸åšï¼‰
        // ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ä¸Šä¼ ï¼Œå¯ä»¥å°è¯•ç”»ä¸€ä¸ªçº¯è‰²èƒŒæ™¯
        // ä½†ä¸ºäº†ç®€å•ï¼Œç­‰å¾…ç”¨æˆ·ä¸Šä¼ å³å¯
    </script>
</body>
</html>
